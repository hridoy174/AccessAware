document.addEventListener("DOMContentLoaded",(function(){var e=document.querySelector("#logList"),t=document.querySelector("#selectAll"),n=document.querySelector("#deleteSelected"),o=document.getElementById("domainFilter"),r=document.getElementById("resourceFilter"),c=document.getElementById("dateFilter"),l=document.getElementById("applyFilters"),a=document.getElementById("clearFilters"),i=document.getElementById("total-records"),d=document.getElementById("camera-accesses"),s=document.getElementById("mic-accesses"),u=document.getElementById("unique-domains"),m=document.getElementById("exportData"),g=document.getElementById("importData"),f=document.getElementById("importFile"),h=[];function y(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};chrome.storage.local.get(["logs"],(function(n){h=n.logs||[],console.log("All logs loaded:",h),i&&function(e){e=e||[],console.log("Updating statistics with",e.length,"logs"),i&&(i.textContent=e.length);var t=e.filter((function(e){return"Camera"===e.resource})).length,n=e.filter((function(e){return"Microphone"===e.resource})).length;d&&(d.textContent=t),s&&(s.textContent=n);var o=new Set(e.map((function(e){return e.url}))).size;u&&(u.textContent=o),console.log("Statistics updated:",{total:e.length,camera:t,mic:n,domains:o})}(h);var o=h;if(t.domain&&(console.log("Filtering by domain:",t.domain),o=o.filter((function(e){return e.url&&e.url.toLowerCase().includes(t.domain.toLowerCase())})),console.log("Filtered logs:",o)),t.resource&&"all"!==t.resource&&(o=o.filter((function(e){return e.resource===t.resource}))),t.date){var r=new Date(t.date);r.setHours(0,0,0,0);var c=new Date(r);c.setDate(c.getDate()+1),o=o.filter((function(e){var t=new Date(e.timestamp);return t>=r&&t<c}))}!function(t){if(e)if(e.innerHTML="",t.length>0)t.reverse().forEach((function(n,o){var r=document.createElement("tr");n.trusted?r.classList.add("trusted-site"):n.blocked&&r.classList.add("blocked-site");var c="Normal";n.trusted&&(c="Trusted"),n.blocked&&(c="Blocked"),"session-end"===n.type&&(c="Session End"),"session-terminated"===n.type&&(c="Session Terminated");var l='\n                    <td><input type="checkbox" data-index="'.concat(t.length-o-1,'" class="logCheckbox"></td>\n                    <td>').concat(n.url,"</td>\n                    <td>").concat(n.resource,"</td>\n                    <td>").concat(new Date(n.timestamp).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}),"</td> "),a=document.querySelectorAll("th");a.length>=5&&(l+="<td>".concat(c,"</td>")),void 0!==n.duration?l+="<td>".concat(n.duration," min</td>"):a.length>=6&&(l+="<td>-</td>"),r.innerHTML=l,e.appendChild(r)}));else{var n=document.querySelectorAll("th").length;e.innerHTML='<tr><td colspan="'.concat(n,'">No logs recorded yet.</td></tr>')}}(o)}))}t&&t.addEventListener("change",(function(){document.querySelectorAll(".logCheckbox").forEach((function(e){return e.checked=t.checked}))})),n&&n.addEventListener("click",(function(){chrome.storage.local.get(["logs"],(function(e){var t=e.logs||[],n=document.querySelectorAll(".logCheckbox:checked"),o=Array.from(n).map((function(e){return parseInt(e.getAttribute("data-index"))}));t=t.filter((function(e,t){return!o.includes(t)})),chrome.storage.local.set({logs:t},(function(){return y()}))}))})),l&&l.addEventListener("click",(function(){y({domain:o.value,resource:r.value,date:c.value})})),a&&a.addEventListener("click",(function(){o&&(o.value=""),r&&(r.value="all"),c&&(c.value=""),y()})),m&&m.addEventListener("click",(function(){chrome.storage.local.get(null,(function(e){var t={logs:e.logs||[],trustedSites:e.trustedSites||[],blockedSites:e.blockedSites||[],notificationsEnabled:e.notificationsEnabled,exportDate:(new Date).toISOString()},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download="accessaware-backup-".concat((new Date).toISOString().split("T")[0],".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}))})),g&&f&&g.addEventListener("click",(function(){if(f.files.length){var e=f.files[0],t=new FileReader;t.onload=function(e){try{var t=JSON.parse(e.target.result);if(!t.logs||!Array.isArray(t.logs))throw new Error("Invalid data format: missing logs array");confirm("Import ".concat(t.logs.length," logs and settings? This will replace your current data."))&&chrome.storage.local.set({logs:t.logs,trustedSites:t.trustedSites||[],blockedSites:t.blockedSites||[],notificationsEnabled:t.notificationsEnabled},(function(){alert("Data imported successfully!"),location.reload()}))}catch(e){alert("Error importing data: ".concat(e.message))}},t.readAsText(e)}else alert("Please select a file to import")})),y()}));